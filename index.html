<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invito Battesimo Emma</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css?family=Great+Vibes|Lora:400,700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Animation -->
    <div id="loading-screen" class="loading-container">
        <div class="envelope">
            <div class="envelope-back"></div>
            <div class="envelope-front">
                <div class="envelope-flap"></div>
            </div>
            <div class="letter">
                <div class="letter-content">
                    <div class="letter-header">Emma</div>
                    <div class="letter-lines">
                        <div class="line"></div>
                        <div class="line"></div>
                        <div class="line"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="loading-text">Aprendo l'invito...</div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="invito-bg" style="display: none;">
        <div class="invito-container">
            <h1 class="titolo-emma">Emma</h1>
            <div class="sottotitolo">è felice di invitarti al suo</div>
            <div class="titolo-evento">Santo Battesimo</div>
            <div class="immagine-arco">
                <img src="emma-battesimo.jpeg" alt="Emma battesimo">
            </div>
            <div class="dettagli">
                <div class="data-ora">
                    <a href="data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0APRODID:-//Test//Test//EN%0ABEGIN:VEVENT%0AUID:santo-battesimo-emma@example.com%0ADTSTAMP:20250721T120000Z%0ADTSTART:20250921T090000Z%0ADTEND:20250921T110000Z%0ASUMMARY:Santo Battesimo Emma%0ADESCRIPTION:A seguire pranzo presso Circolo NOI Andrea Milani%0ALOCATION:Chiesa SS. Fermo e Rustico\, Colognola ai Colli%0AEND:VEVENT%0AEND:VCALENDAR" download="santo-battesimo-emma.ics">
                        21 Settembre 2025 | ore 11:00
                    </a>
                </div>
                <div class="luogo">
                    <a href="https://maps.google.com/?q=Chiesa+SS.+Fermo+e+Rustico,+Colognola+ai+Colli,+Italy" target="_blank">
                        Chiesa SS. Fermo e Rustico
                    </a><br>
                    <a href="https://maps.google.com/?q=Circolo+NOI+Andrea+Milani,+Colognola+ai+Colli,+Italy" target="_blank">
                        Circolo NOI Andrea Milani
                    </a>
                </div>
            </div>
            <div class="nota-finale">A seguire pranzo presso Circolo NOI Andrea Milani</div>
            <div class="parteciperai">
                <h2>Parteciperai?</h2>
                <button onclick="sendWhatsAppResponse('yes')">Sì</button>
                <button onclick="sendWhatsAppResponse('no')">No</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Replace with your actual Lambda API endpoint
        const LAMBDA_API_ENDPOINT = 'https://4sl8y10tm8.execute-api.eu-north-1.amazonaws.com/prod/whatsapp';
        
        // Loading animation
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loading-screen');
                const mainContent = document.getElementById('main-content');
                
                loadingScreen.style.opacity = '0';
                loadingScreen.style.transition = 'opacity 0.5s ease-out';
                
                setTimeout(function() {
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    mainContent.style.opacity = '0';
                    mainContent.style.transition = 'opacity 0.5s ease-in';
                    
                    setTimeout(function() {
                        mainContent.style.opacity = '1';
                    }, 50);
                }, 500);
            }, 3000); // Show loading for 3 seconds
        });
        
        // Function to handle WhatsApp responses
        async function sendWhatsAppResponse(action) {
            // Get the button that was clicked
            const button = event ? event.target : document.querySelector(`button[onclick*="${action}"]`);
            let originalText = 'Sì';
            
            try {
                // Show loading state
                if (button) {
                    originalText = button.textContent;
                    button.textContent = 'Caricamento...';
                    button.disabled = true;
                }
                
                // Call Lambda function
                console.log('Calling API:', `${LAMBDA_API_ENDPOINT}?action=${action}`);
                const response = await fetch(`${LAMBDA_API_ENDPOINT}?action=${action}`);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Full response data:', data);
                
                // Parse the response - it might be double-encoded JSON
                let whatsappUrl = data.whatsappUrl;
                
                // Check if the response body is a string that needs parsing
                if (typeof data === 'string') {
                    try {
                        const parsedData = JSON.parse(data);
                        whatsappUrl = parsedData.whatsappUrl;
                        console.log('Parsed WhatsApp URL:', whatsappUrl);
                    } catch (parseError) {
                        console.log('Failed to parse response as JSON:', parseError);
                    }
                }
                
                // Additional check for nested body
                if (!whatsappUrl && data.body) {
                    try {
                        const bodyData = JSON.parse(data.body);
                        whatsappUrl = bodyData.whatsappUrl;
                        console.log('Found WhatsApp URL in body:', whatsappUrl);
                    } catch (parseError) {
                        console.log('Failed to parse body as JSON:', parseError);
                    }
                }
                
                console.log('Final WhatsApp URL to use:', whatsappUrl);
                
                // Check if we got a valid WhatsApp URL
                if (whatsappUrl && whatsappUrl.includes('wa.me')) {
                    console.log('Opening WhatsApp URL:', whatsappUrl);
                    
                    // Try different methods to open WhatsApp
                    // Method 1: Direct window.open
                    const newWindow = window.open(whatsappUrl, '_blank');
                    
                    // Method 2: If popup blocked, try location.href
                    setTimeout(() => {
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            console.log('Popup blocked, trying direct navigation...');
                            // Give user choice
                            if (confirm('Aprire WhatsApp? (Se il popup è bloccato, verrai reindirizzato direttamente)')) {
                                window.location.href = whatsappUrl;
                            }
                        } else {
                            console.log('WhatsApp opened successfully in new tab');
                        }
                    }, 1000);
                } else {
                    console.error('No valid WhatsApp URL found in response:', data);
                    throw new Error('No WhatsApp URL received from server');
                }
                
                // Reset button
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
                
            } catch (error) {
                console.error('Error details:', error);
                
                // Reset button first
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
                
                // Show user-friendly error
                alert(`Si è verificato un errore: ${error.message}. Verrai reindirizzato a WhatsApp dove potrai inserire manualmente il numero.`);
                window.open('https://wa.me/', '_blank');
            }
        }
    </script>
</body>
</html>